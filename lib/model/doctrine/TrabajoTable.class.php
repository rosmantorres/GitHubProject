<?php

/**
 * TrabajoTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrabajoTable extends Doctrine_Table
{

  /**
   * Returns an instance of this class.
   *
   * @return object TrabajoTable
   */
  public static function getInstance()
  {
    return Doctrine_Core::getTable('Trabajo');
  }

  public function getAlgo()
  {
    $conexion = Doctrine_Manager::connection();
    $consulta = 'SELECT token, url FROM trabajo';
    $sentencia = $conexion->execute($consulta);
    $resultset = $sentencia->execute();
    $resultset = $sentencia->fetch(PDO::FETCH_OBJ);
    //$max = $resultset->token;
    return $resultset;
  }

  public function getTrabajosActivos(Doctrine_Query $q = null)
  {
    /* Se puede hacer asi, pero como ya estamos dentro del modelo no hace falta
     * Doctrine_Query::create()
     */
    /*
      return Doctrine_Core::getTable('Trabajo')
      ->createQuery('t')
      ->where('t.expira_el > ?', date('Y-m-d h:i:s', time()))
      ->execute();
      return Doctrine_Query::create()
      ->from('Trabajo t')
      ->where('t.expira_el > ?', date('Y-m-d h:i:s', time()))
      ->execute();
     */

    /*
    if (is_null($q)) {
      $q = Doctrine_Query::create()
              ->from('Trabajo t');
    }

    return $q->andWhere('t.expira_el > ?', date('Y-m-d h:i:s', time()))
                    ->orderBy('t.expira_el DESC')
                    ->execute();
     * 
     */
    
    return $this->addActiveJobsQuery($q)->execute();
  }

  /*
   * Método que asegura la pagina cuando un puesto de trabajo expira y el usuario
   * aun sabe la URL. No debería ser posible acceder a él nunca más. Este metodo
   * recibira el objeto Doctrine_Query ya listo por parte de la ruta
   * 
   */

  public function recuperarTrabajosActivos(Doctrine_Query $q)
  {    
    //$q->andWhere('a.expira_el > ?', date('Y-m-d h:i:s', time()));
    //return $q->fetchOne();
    return $this->addActiveJobsQuery($q)->fetchOne(); 
  }

  public function countActiveJobs(Doctrine_Query $q = null)
  {
    return $this->addActiveJobsQuery($q)->count();
  }
  
  public function addActiveJobsQuery(Doctrine_Query $q = null)
  {
    if (is_null($q))
    {
      $q = Doctrine_Query::create()
        ->from('Trabajo t');
    }

    $alias = $q->getRootAlias();

    $q->andWhere($alias . '.expira_el > ?', date('Y-m-d h:i:s', time()))
      ->addOrderBy($alias . '.expira_el DESC');

    return $q;
  }
}